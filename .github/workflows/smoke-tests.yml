name: Smoke Tests

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
      jest_pattern:
        description: 'Jest --testNamePattern regex, or empty string for all tests'
        type: string
        default: ''
        required: false
      discriminator:
        default: "true"
        type: string
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        default: dev
        options:
          - dev
          - prod
      jest_pattern:
        description: 'Jest --testNamePattern regex, or empty string for all tests'
        type: string
        default: ''
        required: false

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: runloopai/checkout@main
        with:
          repository: ${{ inputs.discriminator && format('{0}/{1}', github.repository_owner, 'api-client-ts') || github.repository }}

      - name: Setup Node
        uses: runloopai/setup-node@main
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Configure environment
        env:
          DEV_KEY: ${{ secrets.RUNLOOP_SMOKETEST_DEV_API_KEY }}
          PROD_KEY: ${{ secrets.RUNLOOP_SMOKETEST_PROD_API_KEY }}
        run: |
          if [ "${{ inputs.environment }}" = "prod" ]; then
            echo "RUNLOOP_API_KEY=${PROD_KEY}" >> $GITHUB_ENV
            echo "RUNLOOP_BASE_URL=https://api.runloop.ai" >> $GITHUB_ENV
          else
            echo "RUNLOOP_API_KEY=${DEV_KEY}" >> $GITHUB_ENV
            echo "RUNLOOP_BASE_URL=https://api.runloop.pro" >> $GITHUB_ENV
          fi
          echo "DEBUG=false" >> $GITHUB_ENV
          echo "RUN_SMOKETESTS=1" >> $GITHUB_ENV

      - name: Run smoke tests
        id: tests
        run: yarn test:smoke ${{ inputs.jest_pattern && format('--testNamePattern=''{0}''', inputs.jest_pattern) }} --json --outputFile=jest-report.json

      - name: Comment results on PR
        if: failure() && github.event_name == 'pull_request'
        uses: runloopai/github-script@main
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const comment = `## ‚ùå Smoke Tests Failed

            Some smoke tests failed. Please check the logs and fix the issues.

            [üìã View test logs](${runUrl})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment success on PR
        if: success() && github.event_name == 'pull_request'
        uses: runloopai/github-script@main
        with:
          script: |
            const comment = `## ‚úÖ Smoke Tests Passed

            All smoke tests passed successfully!`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Write smoke test summary
        if: always() && steps.tests.outcome != 'skipped'
        uses: runloopai/github-script@main
        with:
          script: |
            const fs = require('fs');
            const env = '${{ inputs.environment }}';
            const outcome = '${{ steps.tests.outcome }}';
            const icon = outcome === 'success' ? '‚úÖ' : outcome === 'failure' ? '‚ùå' : '‚ö†Ô∏è';

            let body = '<table>';
            body += `<tr><th>Environment</th><td><code>${env}</code></td></tr>`;
            body += `<tr><th>Status</th><td>${icon} ${outcome}</td></tr>`;

            if (fs.existsSync('jest-report.json')) {
              const report = JSON.parse(fs.readFileSync('jest-report.json', 'utf8'));
              const total = report.numTotalTests || 0;
              const passed = report.numPassedTests || 0;
              const failed = report.numFailedTests || 0;
              const skipped = report.numPendingTests || 0;
              const duration = report.testResults
                ? (report.testResults.reduce((sum, s) => sum + (s.perfStats?.runtime || 0), 0) / 1000).toFixed(1) + 's'
                : 'unknown';

              body += `<tr><th>Results</th><td>‚úÖ ${passed} passed &nbsp; ‚ùå ${failed} failed &nbsp; ‚è≠Ô∏è ${skipped} skipped &nbsp; (${total} total)</td></tr>`;
              body += `<tr><th>Duration</th><td>${duration}</td></tr>`;
              body += '</table>';

              const failedTests = (report.testResults || [])
                .flatMap(suite => (suite.testResults || []).filter(t => t.status === 'failed')
                  .map(t => ({ suite: suite.testFilePath?.split('/').pop() || '', name: t.fullName, msg: t.failureMessages?.[0]?.split('\n').filter(l => l.trim()).slice(-1)[0] || '' })));

              if (failedTests.length > 0) {
                body += '<h3>‚ùå Failed tests</h3><ul>';
                for (const t of failedTests) {
                  body += `<li><code>${t.suite} &gt; ${t.name}</code>${t.msg ? ` ‚Äî <em>${t.msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</em>` : ''}</li>`;
                }
                body += '</ul>';
              }
            } else {
              body += '</table>';
              body += '<p><em>jest-report.json not found ‚Äî Jest may have failed before generating it.</em></p>';
            }

            await core.summary
              .addHeading(`${icon} SDK Smoke Tests on \`${env}\``, 2)
              .addRaw(body)
              .write();
